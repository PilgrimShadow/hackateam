@(username: String)(implicit messages: Messages)

@loggedInTemplate("Home") {
    <link href="@routes.Assets.at("stylesheets/styled-charts.css")" rel="stylesheet" type="text/css">
} {

    <div id="dashboard-content">

        <div id="study-control">

            <div class="control-panel-element">

                <div id="study-clock">00:00:00</div>

                <form id="study-start-form" class="study-control-form" hidden>

                    <div class="form-group">
                        <input id="study-start-subject-input" class="study-control-input" name="subject" placeholder="Subject" type="text">
                    </div>

                    <button type="submit" id="study-start-button" class="btn btn-default study-control-button">start</button>
                </form>

                <form id="study-stop-form" class="study-control-form" hidden>

                    <div class="form-group">
                        <input id="study-stop-message-input" class="study-control-input" name="message" placeholder="Describe your session" type="text">
                    </div>

                    <button type="submit" id="study-stop-button" class="btn btn-default study-control-button">stop</button>
                </form>

                <form id="study-cancel-form" class="study-control-form" hidden>
                    <button type="submit" class="btn btn-default study-control-button">cancel</button>
                </form>
            </div>

            <div id="subject-list-container" class="control-panel-element"></div>

            <div class="control-panel-element">

                <div id="add-subject-label" class="control-panel-label" onclick="toggleHidden('add-subject-form')">
                    Add a subject <span class="fa fa-lg fa-caret-down control-panel-caret"></span>
                </div>

                <form id="add-subject-form" class="study-control-form" hidden>

                    <div class="form-group">
                        <input id="add-subject-subject-input" class="study-control-input" name="subject" placeholder="New Subject" title="subject name" type="text">
                    </div>

                    <div class="form-group">
                        <input id="add-subject-description-input" class="study-control-input" name="description" placeholder="Description" type="text">
                    </div>

                    <button type="submit" class="btn btn-default study-control-button">add</button>
                </form>
            </div>

            <div class="control-panel-element">

                <div id="rename-subject-label" class="control-panel-label" onclick="toggleHidden('rename-subject-form')">
                    Rename a subject <span class="fa fa-lg fa-caret-down control-panel-caret"></span>
                </div>

                <form id="rename-subject-form" class="study-control-form" hidden>

                    <div class="form-group">
                        <input id="rename-subject-old-subject-input" class="study-control-input" name="oldName" placeholder="Old Name" title="old subject name" type="text">
                    </div>

                    <div class="form-group">
                        <input id="rename-subject-new-subject-input" class="study-control-input" name="newName" placeholder="New Name" title="new subject name" type="text">
                    </div>

                    <button type="submit" class="btn btn-default study-control-button">rename</button>
                </form>

            </div>

        </div>


            <!-- Contains all charts -->
        <div id="summary-content" class="">

                <!-- Today's sessions plot -->
            <div class="">
                <div id="widt-highchart" class="loading-icon"></div>
            </div>

        </div>

    </div>

    <script>

            function toggleHidden(elementID) {

                const elem = $("#" + elementID);

                elem.attr("hidden", !elem.attr("hidden"));
            }

            let studyclock = new StudyClock("study-clock");

            // Initialize the page according to the user's status
            jQuery.ajax({
                url: "@routes.Sessions.userStatus(username)",
                type: "get",
                dataType: "json",
                success: function (data, textStatus, response) {

                    console.log(response.responseText);

                    console.log(data);

                    if (data['payload']['isStudying']) {

                        // Start the stopwatch
                        studyclock.start(data['payload']['start']);

                        // Unhide the stop and cancel forms
                        $("#study-stop-form").removeAttr("hidden");
                        $("#study-cancel-form").removeAttr("hidden");
                    } else {

                        // Unhide the start form
                        $("#study-start-form").removeAttr("hidden");
                    }
                }
            });

    </script>

    <script>
            $(function () {
                $("#study-start-form").on("submit", function (e) {

                    // TODO: prevent fields from clearing
                    e.preventDefault();

                    $.ajax({
                        type: "post",
                        url: "@controllers.routes.Sessions.startSession()",
                        data: $("#study-start-form").serialize(),
                        dataType: "json",
                        complete: function (request, textStatus) {

                            if (request.status === 200) {

                                console.log(request.responseText);

                                let data = {};

                                // Parse the response text as JSON
                                try {
                                    data = JSON.parse(request.responseText);
                                } catch (e) {
                                    console.log("Error parsing response")
                                }

                                if (data['success'] === true) {

                                    // TODO: Return the session start time in the payload

                                    // Start the stopwatch
                                    studyclock.start();

                                    // Unhide the stop and cancel forms
                                    $("#study-stop-form").removeAttr("hidden");
                                    $("#study-cancel-form").removeAttr("hidden");

                                    // Hide and clear the start form
                                    $("#study-start-form").attr("hidden", true);
                                    $("#study-start-subject-input").val("");
                                } else {

                                }
                            }
                        }
                    });
                });
            });


            $(function () {
                $("#study-stop-form").on("submit", function (e) {

                    // TODO: prevent fields from clearing
                    e.preventDefault();

                    $.ajax({
                        type: "post",
                        url: "@controllers.routes.Sessions.stopSession()",
                        data: $("#study-stop-form").serialize(),
                        dataType: "json",
                        complete: function (request, textStatus) {

                            if (request.status === 200) {

                                console.log(request.responseText);

                                let data = {};

                                // Parse the response text as JSON
                                try {
                                    data = JSON.parse(request.responseText);
                                } catch (e) {
                                    console.log("Error parsing response")
                                }

                                if (data['success'] === true) {

                                    $("#study-stop-message-input").val("");

                                    // Reset the clock
                                    studyclock.reset();

                                    $("#study-start-form").removeAttr("hidden");
                                    $("#study-stop-form").attr("hidden", true);
                                    $("#study-cancel-form").attr("hidden", true);
                                } else {

                                }
                            }
                        }
                    });
                });
            });


            $(function () {
                $("#study-cancel-form").on("submit", function (e) {

                    // TODO: prevent fields from clearing
                    e.preventDefault();

                    $.ajax({
                        type: "post",
                        url: "@controllers.routes.Sessions.cancelSession()",
                        data: $("#study-cancel-form").serialize(),
                        dataType: "json",
                        complete: function (request, textStatus) {

                            if (request.status === 200) {

                                console.log(request.responseText);

                                let data = {};

                                // Parse the response text as JSON
                                try {
                                    data = JSON.parse(request.responseText);
                                } catch (e) {
                                    console.log("Error parsing response")
                                }

                                if (data['success'] === true) {
                                    console.log(data);
                                    $("#study-stop-message-input").val("");

                                    // Reset the clock
                                    studyclock.reset();

                                    $("#study-start-form").removeAttr("hidden");
                                    $("#study-stop-form").attr("hidden", true);
                                    $("#study-cancel-form").attr("hidden", true);
                                } else {

                                }
                            }
                        }
                    });
                });
            });


            $(function () {
                $("#add-subject-form").on("submit", function (e) {

                    // TODO: prevent fields from clearing
                    e.preventDefault();

                    $.ajax({
                        type: "post",
                        url: "@controllers.routes.Sessions.addSubject()",
                        data: $("#add-subject-form").serialize(),
                        dataType: "json",
                        complete: function (request, textStatus) {

                            if (request.status === 200) {

                                console.log(request.responseText);

                                let data = {};

                                // Parse the response text as JSON
                                try {
                                    data = JSON.parse(request.responseText);
                                } catch (e) {
                                    console.log("Error parsing response")
                                }

                                if (data['success'] === true) {
                                    console.log(data);
                                    // Clear the form inputs
                                    $("#add-subject-subject-input").val("");
                                    $("#add-subject-description-input").val("");
                                } else {
                                    // Handle errors: subject already added, etc.
                                }
                            }
                        }
                    });
                });
            });

            $(function () {
                $("#rename-subject-form").on("submit", function (e) {

                    // TODO: prevent fields from clearing
                    e.preventDefault();

                    $.ajax({
                        type: "post",
                        url: "@controllers.routes.Sessions.renameSubject()",
                        data: $("#rename-subject-form").serialize(),
                        dataType: "json",
                        complete: function (request, textStatus) {

                            if (request.status === 200) {

                                console.log(request.responseText);

                                let data = {};

                                // Parse the response text as JSON
                                try {
                                    data = JSON.parse(request.responseText);
                                } catch (e) {
                                    console.log("Error parsing response")
                                }

                                if (data['success'] === true) {

                                    console.log(data);

                                    // Clear the form inputs
                                    $("#rename-subject-new-subject-input").val("");
                                    $("#rename-subject-old-subject-input").val("");
                                } else {
                                    // Handle errors: subject already added, etc.
                                }
                            }
                        }
                    });
                });
            });

    </script>

        <!-- Used in defining the gradient for area charts -->
    <svg style="height: 0">
        <defs>
            <linearGradient id="gradient-0" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0" />
                <stop offset="1" />
            </linearGradient>
        </defs>
    </svg>

    <script src="@routes.Assets.at("/javascripts/stats.js")"></script>

        <!-- Moment JS -->
    <script src="@routes.Assets.at("/javascripts/moment.js")"></script>
    <script src="@routes.Assets.at("/javascripts/moment-timezone-10-20.js")"></script>

    <script>



            /*
             * Compute all of the statistics
             */
            function computeStats(sessions) {

                const dayGroups = splitDays(sessions);

                const dTotals = dailyTotals(dayGroups);

                return {
                    "cumulative": cumulative(sessions, 100),
                    "denseCumulative": denseCumulative(dayGroups),
                    "total": sumRawSessions(sessions),
                    "dailyAverage": dailyAverage(dayGroups),
                    "todaysSessions": todaysSessions(dayGroups),
                    "monthsSessions": currentMonthSessions(dayGroups),
                    "todaysTotal": todaysTotal(dayGroups),
                    "currentStreak": currentStreak(dayGroups),
                    "daysSinceStart": daysSinceStart(dayGroups),
                    "probability": probability(97, dayGroups),
                    "probabilityWithTime": probabilityWithTime(96, dayGroups),
                    "movingAverage": movingAverage(dayGroups, movingAverageRadius),
                    "dailyTotals": dTotals,
                    "dailyTotalHistogram": dailyTotalHistogram(dTotals, 12),
                    "dayOfWeekAverages": dayOfWeekAverages(dayGroups),
                    "yearlyTotals": yearlyTotals(dayGroups),
                    "subjectTotals": subjectTotals(sessions, 10)
                }
            }

    </script>

    <script src="@routes.Assets.at("javascripts/SubjectList.js")"></script>

    <script>

            function fillSummaryValues(stats) {

                const n1 = stats.todaysTotal.toFixed(2).toString();
                const n2 = stats.dailyAverage.toFixed(2).toString();

                document.getElementById("streak-count").innerText = stats.currentStreak.toString() + " d";
                document.getElementById("current-day-total").innerText = n1;
                document.getElementById("average-day-total").innerText = n2;
            }


            jQuery.ajax({
                url: "@routes.Sessions.sessionsForUsername(username)",
                type: "get",
                dataType: "json",
                success: function (data, textStatus, response) {

                    // Add the current session to the session array
                    if (data.status.isStudying) {
                        data.sessions.push({
                            "subject": data.status.subject,
                            "startTime": data.status.start,
                            "endTime": new Date().getTime()
                        });
                    }

                    const subjectList = new SubjectList("subject-list-container", data.subjects);

                    function cmp(sub1, sub2) {
                        if (sub1[1] < sub2[1]) {
                            return 1;
                        }

                        if (sub1[1] > sub2[1]) {
                            return -1;
                        }

                        return 0;
                    }
                }
            });
    </script>
}